# Chapter21 基于物理的渲染

[返回](../../README.md)

本章节使用点光源实现基于物理的渲染(PBR)。$L_o(\mathbf{v}) = \int_{\Omega} f(\mathbf{l}, \mathbf{v})\, L_i(\mathbf{l})\, (\mathbf{n}\cdot \mathbf{l})\, d\omega_i$

这个积分表达的是：
- 表面沿着观察方向 **v** 朝向观察者发出的出射辐亮度(**Lo**)，等于对 **BRDF**(**f**)与入射辐亮度(**Li**)的乘积做积分(可以把积分理解成一种 带权求和)。
- 这个积分是在表面上方的半球区域内进行的：半球内所有可能的入射光方向 **l** 都要考虑，并且要乘上一个余弦因子 **(n · l)** 作为权重。这个余弦因子本质上反映了几何关系：光线越是正对着表面射来(越接近法线方向)，它的权重就越大。
- 更具体的 PBR 的推到可以在 [LearnOpenGL](https://learnopengl-cn.github.io/07%20PBR/01%20Theory/) 中找到。

## 21.1 BRDF 介绍

本章节中 **BRDF** 分为两个部分: 漫反射BRDF 和 镜面反射BRDF，$f(\mathbf{l}, \mathbf{v}) = f_d + f_s$

### 21.1.1 漫反射 BRDF

漫反射 BRDF 表示光线被表面稍微吸收后再重新辐射。通常对这一项进行建模时，假设辐射光没有特定的方向，它在所有出射方向上均匀辐射，也称为朗伯反射。由于它不依赖于入射或出射方向，朗伯 BRDF 只是一个常数值: $f_d = \frac{c_{\mathrm{diff}}}{\pi}$

其中 cdiff 术语表示漫散射的光的分数，通常是物体的漫反射颜色。

### 21.1.2 镜面反射 BRDF

镜面项表示表面反射率。
光线直接从物体表面反射而不被吸收，有时也被称为光泽反射。
一种常见这种反射的方法是基于微表面理论。
该理论是为描述一般非光学平坦表面的反射而开发的。
它将表面建模为由小的光学平坦(镜面)小面组成，并朝向不同方向。
只有那些方向正确、能够朝向观察者反射的面才能对双向反射分布函数(BRDF)有所贡献。
可以在 [LearnOpenGL](https://learnopengl-cn.github.io/07%20PBR/01%20Theory/) 中查看详细理论。

这个BRDF用三个项的乘积以及一个校正因子(分母)表示: $f_s = \frac{F(\mathbf{l}, \mathbf{h})\, G(\mathbf{l}, \mathbf{v}, \mathbf{h})\, D(\mathbf{h})}{4(\mathbf{n}\cdot \mathbf{l})(\mathbf{n}\cdot \mathbf{v})}$

#### 21.1.2.1 菲涅尔项

F 项表示菲涅尔反射，即从光学平面表面反射的光的比例。菲涅尔反射率取决于法线与入射光方向(入射角)之间的角度。
由于我们使用的是微表面理论，实际起作用的微表面是法向量与半程向量(h)平行的那些表面。
因此，使用光线方向 l 与半程向量 h 之间的角度，而不是光线方向 l 与法线 n 之间的角度。
菲涅尔反射率还取决于表面的折射率。使用另一种参数的近似方法。这被称为 Schlick 近似法: $F(\mathbf{l}, \mathbf{h}) = F_0 + (1 - F_0)\,(1 - (\mathbf{l}\cdot \mathbf{h}))^5$
这种近似方法不是使用折射率，而是使用 F0，即材料的特征镜面反射率。换句话说，就是入射角为零度时的反射率。

为了进一步理解这个 F0 项，考虑一些常见材料的数值。
事实证明，材料的光学特性与其电学特性密切相关。
将材料分为三类：介电材料(绝缘体)、金属(导体)和半导体。
- 金属通常不会表现出任何漫反射，因为任何进入表面的光都会被自由电子完全吸收。金属的 F0 值远高于介电材料。
- 介电材料的 F0 值很低，通常在 0.05 左右(适用于所有 RGB 分量)。

将颜色与材料关联: 
- 如果材料是金属，则没有漫反射，因此将 cdiff 设置为 (0,0,0)，并将颜色用作 Fresnel 项中 F0 的值。
- 如果材料是介电材料，将 F0 设置为一个较小的值(如(0.04, 0.04, 0.04))，并将颜色用作 cdiff 的值。
- 基本上，对金属和介电材料使用两种略有不同的模型，并根据需要在两者之间切换。与其为金属和非金属使用相同的模型并调整参数来表示每种材料，不如将它们分为两类，每类使用稍有不同的 BRDF 模型。

#### 21.1.2.2 法线分布函数

镜面反射 BRDF 中的 D 项是微几何法线分布函数(或微表面分布函数)。
它描述了微表面取向的统计分布。
它具有标量值，并给出微面法线在方向 h 上的相对集中度。
此项对镜面高光的大小和形状有显著影响。
对于此函数，有许多选择，并且近年来基于物理测量开发了几种。
本章节使用图形学研究者 Trowbridge 和 Reitz 提出的一种常用函数 GGX:
$$
D(\mathbf{h})=\frac{\alpha^2}{\pi\left((\mathbf{n}\cdot\mathbf{h})^2(\alpha^2-1)+1\right)^2}
$$

在这个方程中，α 是一个表示表面粗糙度的项。设置粗糙度参数 r，并将 α 设为 r²。

#### 21.1.2.3 几何函数

镜面反射 BRDF 中的 G 项是几何函数，描述了具有给定法线的微表面从光照方向(l)和观察方向(v)均可见的概率。
它的取值是介于 0 到 1 之间的标量。它对于能量守恒至关重要。本章节将使用 G 模型: $G(\mathbf{l}, \mathbf{v}, \mathbf{h}) = G_1(\mathbf{l})\, G_1(\mathbf{v})$

其中$G_1(\mathbf{v})=\frac{\mathbf{n}\cdot\mathbf{v}}{(\mathbf{n}\cdot\mathbf{v})(1-k)+k}$

常数 k 是与粗糙度成正比的值: $k=\frac{(r+1)^2}{8}$

**注:** 一些场景的 PBR 资料可以从 [这里](http:/​/​blog.​selfshadow.com/​publications/​s2013-​shading-​course/​) 找到



## 模拟雾渲染展示

![模拟雾渲染展示](./images/模拟雾渲染展示.gif)

[返回](../../README.md)