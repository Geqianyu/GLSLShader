# Chapter27 使用视差贴图自阴影

[返回](../../README.md)

本章节基于 [Chapter26](../chapter26/Chapter26.md)。

**陡峭视差映射**由Morgan McGuire和Max McGuire于2005年首次发表。
它在视差映射的基础上进行了改进，产生了更好的效果，不过需要更多的片元着色器计算。
尽管成本增加，该算法仍然非常适合在现代 **GPU** 上进行实时渲染。

该技术涉及将视线通过高度图沿离散步骤进行追踪，直到找到碰撞，以更精确地确定纹理坐标的适当偏移。
将高度图分成 n 个离散层级(由虚线表示)。

![陡峭视差贴图示意图](./images/陡峭视差贴图示意图.png)

查询偏移纹理坐标，使表面根据凹凸表面而非真实表面进行着色。
点 **P** 是正在渲染的多边形上的表面点。
从点 **P** 沿视线向量依次追踪到每一级，直到找到位于凹凸表面上或下的点。
在上图中，在三次迭代后找到点 **Q**。

使用相似三角形(参见[Chapter26](../chapter26/Chapter26.md))推导出单次迭代中 **x** 和 **y** 的变化:

$$
P' = P + \frac{S}{n}\left(\frac{v_x}{v_z},\,\frac{v_y}{v_z}\right)
$$

缩放因子(**S**)用于改变效果的影响程度，并将其缩放到纹理空间。**n** 是高度级别的数量。

使用这个方程，可以按高度级别逐步前进，从 **P** 点开始，沿着视线远离相机。
一直进行，直到找到一个位于高度图表面或下方的点。
然后使用该点的纹理坐标进行着色。
实际上，是在片元着色器中实现一个非常简单的光线行进器。

一旦找到点 **Q**，就会沿光源方向再投射一条射线。
如果该射线与表面相交，则该点处于阴影中，只使用环境光来着色。否则，正常为该点着色。

![陡峭视察贴图阴影查找示意图](./images/陡峭视察贴图阴影查找示意图.png)

## 27.1 陡峭视差贴图渲染展示

![陡峭视差贴图渲染展示](./images/陡峭视差贴图渲染展示.png)

[返回](../../README.md)