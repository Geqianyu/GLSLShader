# Chapter43 使用几何着色器的点精灵

[返回](../../README.md)

## 43.1 几何着色器简介

几何着色器(GS)设计为每个图元执行一次。
它可以访问该图元的所有顶点，以及与每个顶点相关联的任何输入变量的值。
即，如果前一阶段(例如顶点着色器)提供了一个输出变量，几何着色器可以访问该图元中所有顶点的该变量值。
因此，几何着色器中的输入变量始终是数组。

几何着色器可以输出**零**个、一个或多个图元。
这些图元不必与几何着色器接收的图元种类相同。

几何着色器(GS)只能输出一种基本类型。
例如，几何着色器可以接收一个三角形，并将多个线段输出为一个线带，
或者几何着色器可以接收一个三角形，并将零个或多个三角形输出为一个三角带。

几何着色器(GS)能够以多种不同方式运行。
几何着色器可以负责根据某些标准剔除几何图形，例如基于遮挡的可见性。
它可以生成额外的几何图形，以增强正在渲染的对象的形状。
几何着色器可以简单地计算有关图元的额外信息，并保持图元不变地传递下去，
也可以生成与输入几何图形完全不同的图元。

几何着色器(GS)的功能围绕两个内置函数展开:
- `EmitVertex`: 几何着色器为特定顶点定义输出变量，然后调用 `EmitVertex`，之后，几何着色器可以重新定义下一个顶点的输出变量，再次调用 `EmitVertex`，以此类推。如果几何着色器完全没有调用 `EmitVertex`，输入的图元会被丢弃(不会被渲染)。
- `EndPrimitive`: 在发射完一个图元的所有顶点后，几何着色器可以调用 `EndPrimitive`，让 OpenGL 系统知道该图元的所有顶点都已发射完毕。当几何着色器执行结束时，`EndPrimitive` 函数会被隐式调用。

## 43.2 点精灵简介

点精灵是简单的四边形(通常进行纹理映射)，其对齐方式确保它们始终面向相机。
它们在 3D 或 2D 游戏的粒子系统中非常有用。
OpenGL 应用程序通过 `GL_POINTS` 渲染模式，将点精灵指定为单点图元。
这简化了流程，因为四边形本身以及四边形的纹理坐标是自动确定的。
应用程序的 OpenGL 部分可以有效地将它们视为点图元，无需计算四边形顶点的位置。

OpenGL 在 `GL_POINTS` 渲染模式中已内置对点精灵的支持。
使用此模式渲染点图元时，点会被渲染为屏幕空间中的正方形，其直径由 `glPointSize` 函数定义。
此外，OpenGL 会自动为正方形的片段生成纹理坐标。
这些坐标在每个方向上的范围都是从 0 到 1，可在片段着色器中通过内置变量 `gl_PointCoord` 访问。

在 OpenGL 中，有多种方法可以微调点精灵的渲染效果。
可以使用 `glPointParameter` 函数来定义自动生成的纹理坐标的原点。
同样的函数集还可用于调整在启用多重采样时 OpenGL 定义点的 alpha 值的方式。

内置的点精灵支持不允许程序员旋转屏幕空间中的正方形，也不允许将它们定义为不同的形状，如矩形或三角形。
不过，通过创造性地使用纹理和对纹理坐标进行变换，可以实现类似的效果。
例如，可以使用旋转矩阵来变换纹理坐标，从而营造出物体在旋转的视觉效果，尽管几何体本身实际上并没有旋转。
此外，点精灵的大小是屏幕空间中的大小。即，如果想要获得透视效果，就必须根据点精灵的深度来调整其大小。

## 43.3 使用几何着色器的点精灵渲染展示

![使用几何着色器的点精灵渲染展示](./images/使用几何着色器的点精灵渲染展示.png)

[返回](../../README.md)